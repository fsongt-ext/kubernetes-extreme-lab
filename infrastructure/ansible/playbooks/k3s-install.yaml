---
##############################################################################
# K3s Installation Playbook
#
# Installs and configures K3s with security hardening
# Target: Single-node lab cluster (2 vCPU / 8GB RAM)
##############################################################################

- name: Install K3s Kubernetes Cluster
  hosts: k3s_cluster
  become: true
  gather_facts: true

  vars:
    k3s_version: "{{ k3s_version | default('v1.30.0+k3s1') }}"
    k3s_install_dir: /usr/local/bin
    k3s_config_dir: /etc/rancher/k3s
    k3s_data_dir: /var/lib/rancher/k3s

  pre_tasks:
    - name: Display cluster information
      ansible.builtin.debug:
        msg:
          - "Cluster Name: {{ cluster_name }}"
          - "Environment: {{ environment }}"
          - "K3s Version: {{ k3s_version }}"
          - "Pod CIDR: {{ pod_cidr }}"
          - "Service CIDR: {{ service_cidr }}"

    - name: Check system resources
      ansible.builtin.assert:
        that:
          - ansible_memtotal_mb >= 7168  # At least 7GB RAM
          - ansible_processor_vcpus >= 2
        fail_msg: "Insufficient system resources for K3s cluster"
        success_msg: "System resources adequate"

  roles:
    - role: common
      tags: [common, prereqs]

    - role: security
      tags: [security, hardening]

    - role: k3s
      tags: [k3s, install]

    - role: monitoring
      tags: [monitoring, observability]

  post_tasks:
    - name: Wait for K3s to be ready
      ansible.builtin.command: k3s kubectl get nodes
      register: k3s_nodes
      until: k3s_nodes.rc == 0
      retries: 10
      delay: 10
      changed_when: false

    - name: Display cluster status
      ansible.builtin.debug:
        msg: "{{ k3s_nodes.stdout_lines }}"

    - name: Verify system pods
      ansible.builtin.command: k3s kubectl get pods -n kube-system
      register: system_pods
      changed_when: false

    - name: Display system pods
      ansible.builtin.debug:
        msg: "{{ system_pods.stdout_lines }}"

    - name: Setup kubeconfig for current user
      ansible.builtin.copy:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{{ ansible_env.HOME }}/.kube/config"
        remote_src: true
        owner: "{{ ansible_user_id }}"
        group: "{{ ansible_user_gid }}"
        mode: '0600'
      when: ansible_connection != 'local'

    - name: Display success message
      ansible.builtin.debug:
        msg:
          - "âœ“ K3s cluster installed successfully!"
          - "Cluster: {{ cluster_name }}"
          - "Version: {{ k3s_version }}"
          - ""
          - "Next steps:"
          - "1. export KUBECONFIG=/etc/rancher/k3s/k3s.yaml"
          - "2. kubectl get nodes"
          - "3. kubectl get pods -A"
