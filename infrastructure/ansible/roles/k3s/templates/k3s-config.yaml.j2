# K3s Configuration File
# Generated by Ansible

# Network Configuration
cluster-cidr: "{{ pod_cidr }}"
service-cidr: "{{ service_cidr }}"
cluster-dns: "{{ cluster_dns }}"

# Disable default components (we'll install our own)
disable:
  - traefik
  - servicelb
  - local-storage

# Kubeconfig
write-kubeconfig-mode: "0644"
write-kubeconfig: /etc/rancher/k3s/k3s.yaml

# Security - Secrets Encryption
{% if enable_secrets_encryption | default(true) %}
secrets-encryption: true
{% endif %}

# Security - Kernel Defaults
protect-kernel-defaults: false  # Set to true for production

# API Server Arguments
kube-apiserver-arg:
{% if enable_audit_logging | default(true) %}
  - "audit-log-path=/var/lib/rancher/k3s/server/logs/audit.log"
  - "audit-log-maxage=30"
  - "audit-log-maxbackup=10"
  - "audit-log-maxsize=100"
{% endif %}
  - "anonymous-auth=false"
  - "enable-admission-plugins=NodeRestriction,PodSecurityPolicy"

# Controller Manager Arguments
kube-controller-manager-arg:
  - "terminated-pod-gc-threshold=10"

# Kubelet Arguments
kubelet-arg:
  - "max-pods=110"
  - "eviction-hard=memory.available<500Mi,nodefs.available<10%"
  - "eviction-soft=memory.available<1Gi,nodefs.available<15%"
  - "eviction-soft-grace-period=memory.available=1m30s,nodefs.available=2m"

# Flannel Backend (default: vxlan)
flannel-backend: vxlan

# Disable components (using our own)
disable-cloud-controller: true
disable-network-policy: false

# TLS SANs (add your domain/IP)
# tls-san:
#   - "k3s.example.com"
#   - "192.168.1.100"
